# Sistema de Sequ√™ncias (Playbooks)

## üìã Vis√£o Geral

Sistema completo de cria√ß√£o e gerenciamento de **Sequ√™ncias** (playbooks de mensagens) para campanhas de WhatsApp. 

Uma **Sequ√™ncia** √© uma lista linear de passos (texto, imagem, √°udio, v√≠deo, documento) com delays opcionais entre cada passo.

### ‚úÖ O que foi implementado

**Backend:**
- ‚úÖ 9 endpoints REST para CRUD completo de sequ√™ncias
- ‚úÖ Suporte a draft/published/archived
- ‚úÖ Versionamento autom√°tico ao publicar
- ‚úÖ Duplica√ß√£o de sequ√™ncias
- ‚úÖ Teste de envio (integra√ß√£o N8N)
- ‚úÖ Busca com unaccent (busca sem acentua√ß√£o)

**Frontend:**
- ‚úÖ P√°gina de listagem (`/sequencias`) com busca, filtros e pagina√ß√£o
- ‚úÖ Cria√ß√£o de novas sequ√™ncias
- ‚úÖ A√ß√µes: Editar, Duplicar, Arquivar
- ‚úÖ TypeScript types completos
- ‚úÖ Integra√ß√£o com API

---

## üóÑÔ∏è Banco de Dados

### Tabelas Existentes

```sql
-- Sequ√™ncias (playbooks)
CREATE TABLE public.comms_sequences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES public.organizations(id),
  name TEXT NOT NULL,
  channel TEXT NOT NULL DEFAULT 'whatsapp',
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'archived')),
  runner_kind TEXT DEFAULT 'n8n',
  active BOOLEAN DEFAULT true,
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Passos da sequ√™ncia
CREATE TABLE public.comms_sequence_steps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sequence_id UUID NOT NULL REFERENCES public.comms_sequences(id) ON DELETE CASCADE,
  idx INTEGER NOT NULL CHECK (idx >= 1),
  kind TEXT NOT NULL CHECK (kind IN ('text', 'image', 'audio', 'video', 'document')),
  cfg JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### √çndices Recomendados

```sql
-- Performance para listagem e busca
CREATE INDEX IF NOT EXISTS ix_seq_org_status_updated 
  ON public.comms_sequences(org_id, status, updated_at DESC);

CREATE INDEX IF NOT EXISTS ix_seq_org_channel 
  ON public.comms_sequences(org_id, channel);

CREATE INDEX IF NOT EXISTS ix_seq_steps_sequence 
  ON public.comms_sequence_steps(sequence_id, idx);

-- Habilitar busca sem acentua√ß√£o
CREATE EXTENSION IF NOT EXISTS unaccent;
```

### Estrutura do campo `cfg` (JSONB)

```typescript
// Para passos de TEXTO
{
  "text": "Oi {first_name}, tudo bem?",
  "delayNextSeconds": 5  // opcional
}

// Para passos de M√çDIA (image/audio/video/document)
{
  "fileId": "uuid-do-arquivo",
  "caption": "Legenda opcional",
  "filename": "documento.pdf",  // apenas para document
  "delayNextSeconds": 10
}
```

---

## üîå Backend - API Endpoints

### Base URL
```
http://localhost:3000/api
```

### Headers obrigat√≥rios
```
Authorization: Bearer <jwt_token>
X-Org-Id: <organization_uuid>
```

---

### 1. **Listar Sequ√™ncias**
```http
GET /api/sequences?status=draft&channel=whatsapp&q=recuperacao&page=1&limit=20
```

**Query Params:**
- `status` (opcional): `draft` | `published` | `archived`
- `channel` (opcional): `whatsapp`
- `q` (opcional): busca no nome (sem acentua√ß√£o)
- `page` (padr√£o: 1)
- `limit` (padr√£o: 20, m√°x: 100)

**Response 200:**
```json
{
  "items": [
    {
      "id": "uuid",
      "org_id": "uuid",
      "name": "Sequ√™ncia de Recupera√ß√£o",
      "channel": "whatsapp",
      "status": "published",
      "version": 2,
      "active": true,
      "created_at": "2025-01-15T10:00:00Z",
      "updated_at": "2025-01-16T14:30:00Z",
      "steps_count": 3
    }
  ],
  "total": 42,
  "page": 1,
  "limit": 20
}
```

---

### 2. **Criar Sequ√™ncia (Draft)**
```http
POST /api/sequences
Content-Type: application/json

{
  "name": "Minha Nova Sequ√™ncia",
  "channel": "whatsapp"
}
```

**Response 201:**
```json
{
  "sequence": {
    "id": "uuid",
    "org_id": "uuid",
    "name": "Minha Nova Sequ√™ncia",
    "channel": "whatsapp",
    "status": "draft",
    "version": 1,
    "active": true,
    "created_at": "2025-01-17T10:00:00Z",
    "updated_at": "2025-01-17T10:00:00Z"
  }
}
```

---

### 3. **Ler Sequ√™ncia + Passos**
```http
GET /api/sequences/:id
```

**Response 200:**
```json
{
  "sequence": {
    "id": "uuid",
    "name": "Recupera√ß√£o VIP",
    "status": "published",
    "version": 2
  },
  "steps": [
    {
      "id": "step-uuid-1",
      "sequence_id": "uuid",
      "idx": 1,
      "kind": "text",
      "cfg": {
        "text": "Oi {first_name}, sentimos sua falta!",
        "delayNextSeconds": 5
      }
    },
    {
      "id": "step-uuid-2",
      "sequence_id": "uuid",
      "idx": 2,
      "kind": "image",
      "cfg": {
        "fileId": "image-uuid",
        "caption": "Veja essa oferta especial!",
        "delayNextSeconds": 10
      }
    }
  ]
}
```

---

### 4. **Atualizar Metadados (apenas Draft)**
```http
PUT /api/sequences/:id
Content-Type: application/json

{
  "name": "Novo Nome da Sequ√™ncia",
  "active": true
}
```

**Response 200:**
```json
{
  "sequence": { /* sequ√™ncia atualizada */ }
}
```

**Erro 404:** Sequ√™ncia n√£o encontrada ou n√£o est√° em draft

---

### 5. **Salvar Passos (apenas Draft)**
```http
PUT /api/sequences/:id/steps
Content-Type: application/json

{
  "steps": [
    {
      "kind": "text",
      "cfg": {
        "text": "Ol√° {first_name}!",
        "delayNextSeconds": 3
      }
    },
    {
      "kind": "image",
      "cfg": {
        "fileId": "file-uuid-123",
        "caption": "Confira essa novidade"
      }
    }
  ]
}
```

**Valida√ß√µes:**
- `kind` deve ser: `text` | `image` | `audio` | `video` | `document`
- `text` step requer `cfg.text`
- M√≠dia steps requerem `cfg.fileId`
- `delayNextSeconds` deve ser >= 0 se presente

**Response 200:**
```json
{
  "steps": [
    {
      "id": "uuid",
      "sequence_id": "seq-uuid",
      "idx": 1,
      "kind": "text",
      "cfg": { "text": "Ol√° {first_name}!", "delayNextSeconds": 3 }
    }
  ]
}
```

---

### 6. **Publicar Sequ√™ncia**
```http
POST /api/sequences/:id/publish
```

**Valida√ß√µes:**
- Deve ter pelo menos 1 passo
- Deve estar em status `draft`

**Response 200:**
```json
{
  "sequence": {
    "id": "uuid",
    "status": "published",
    "version": 2,  // incrementado
    "updated_at": "2025-01-17T10:30:00Z"
  }
}
```

**Efeitos:**
- `status` ‚Üí `published`
- `version` incrementado (+1)
- Trava edi√ß√£o (n√£o pode mais alterar passos)

---

### 7. **Duplicar Sequ√™ncia**
```http
POST /api/sequences/:id/duplicate
```

**Response 201:**
```json
{
  "sequence": {
    "id": "new-uuid",
    "name": "Recupera√ß√£o VIP (c√≥pia)",
    "status": "draft",
    "version": 1
  },
  "steps": [ /* todos os passos copiados */ ]
}
```

**Permite:** Criar novo draft a partir de qualquer sequ√™ncia (draft, published ou archived)

---

### 8. **Teste de Envio**
```http
POST /api/sequences/:id/test-send
Content-Type: application/json

{
  "wa_number": "5511999998888",
  "vars": {
    "first_name": "Jo√£o",
    "coupon": "SAVE20"
  }
}
```

**Response 202:**
```json
{
  "ok": true,
  "test_run_id": "test-uuid-123"
}
```

**Integra√ß√£o:** Chama N8N webhook configurado em `N8N_SEQUENCE_TEST_URL`

---

### 9. **Arquivar Sequ√™ncia**
```http
POST /api/sequences/:id/archive
```

**Valida√ß√µes:**
- Deve estar em status `published`

**Response 200:**
```json
{
  "sequence": {
    "id": "uuid",
    "status": "archived",
    "updated_at": "2025-01-17T11:00:00Z"
  }
}
```

---

## üé® Frontend - Estrutura

### Arquivos Criados/Modificados

```
src/
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ sequences.ts                    # ‚úÖ Types TypeScript
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ api.ts                          # ‚úÖ sequencesApi adicionado
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ Sequences.tsx                   # ‚úÖ Listagem principal
```

### Tipos TypeScript

```typescript
// src/types/sequences.ts
export type SequenceStatus = 'draft' | 'published' | 'archived';
export type StepKind = 'text' | 'image' | 'audio' | 'video' | 'document';

export type StepCfg =
  | { text: string; delayNextSeconds?: number }
  | { fileId: string; caption?: string; filename?: string; delayNextSeconds?: number };

export interface Sequence {
  id: string;
  org_id: string;
  name: string;
  channel: 'whatsapp';
  status: SequenceStatus;
  version: number;
  active: boolean;
  created_at: string;
  updated_at: string;
  steps_count?: number;
}

export interface SequenceStep {
  id: string;
  sequence_id: string;
  idx: number;
  kind: StepKind;
  cfg: StepCfg;
}

export interface SequenceWithSteps {
  sequence: Sequence;
  steps: SequenceStep[];
}
```

### API Client

```typescript
// src/lib/api.ts - exemplo de uso
import { sequencesApi } from '@/lib/api';

// Listar
const { items, total } = await sequencesApi.list({
  status: 'published',
  q: 'recuperacao',
  page: 1,
  limit: 20
});

// Criar
const { sequence } = await sequencesApi.create({
  name: 'Nova Sequ√™ncia',
  channel: 'whatsapp'
});

// Ler
const { sequence, steps } = await sequencesApi.getById(sequenceId);

// Publicar
await sequencesApi.publish(sequenceId);

// Duplicar
const { sequence: newSeq, steps: newSteps } = await sequencesApi.duplicate(sequenceId);
```

---

## ‚öôÔ∏è Configura√ß√£o

### 1. Vari√°veis de Ambiente (Backend)

Adicione ao `backend/.env`:

```bash
# Webhook N8N para teste de envio de sequ√™ncias
N8N_SEQUENCE_TEST_URL=https://n8n.seudominio.com/webhook/sequence-test

# Token interno para autenticar chamadas ao N8N (opcional)
INTERNAL_TOKEN=seu-token-secreto-aqui
```

### 2. Registrar Router no Backend

J√° configurado em `backend/src/server.ts`:

```typescript
import { sequencesRouter } from './routes/sequences';

app.use('/api', sequencesRouter);
```

### 3. Executar Migra√ß√µes (se necess√°rio)

```bash
cd backend
npm run migrate  # ou seu comando de migra√ß√£o
```

**Ou execute manualmente:**

```sql
-- Criar tabelas (se n√£o existirem)
CREATE TABLE IF NOT EXISTS public.comms_sequences ( /* ... */ );
CREATE TABLE IF NOT EXISTS public.comms_sequence_steps ( /* ... */ );

-- Criar √≠ndices
CREATE INDEX IF NOT EXISTS ix_seq_org_status_updated ON public.comms_sequences(org_id, status, updated_at DESC);
CREATE INDEX IF NOT EXISTS ix_seq_org_channel ON public.comms_sequences(org_id, channel);
CREATE INDEX IF NOT EXISTS ix_seq_steps_sequence ON public.comms_sequence_steps(sequence_id, idx);

-- Habilitar busca sem acentua√ß√£o
CREATE EXTENSION IF NOT EXISTS unaccent;
```

---

## üöÄ Como Usar

### 1. Iniciar Backend
```bash
cd backend
npm install
npm run dev  # porta 3000
```

### 2. Iniciar Frontend
```bash
npm install
npm run dev  # porta 8080
```

### 3. Acessar Interface

Navegue para: `http://localhost:8080/sequencias`

**Fluxo:**
1. ‚úÖ Ver lista de sequ√™ncias existentes
2. ‚úÖ Criar nova sequ√™ncia (bot√£o "Nova Sequ√™ncia")
3. ‚úÖ Duplicar sequ√™ncias existentes
4. ‚úÖ Filtrar por status (Draft, Published, Archived)
5. ‚úÖ Buscar pelo nome

---

## üìù Pr√≥ximos Passos (N√£o Implementados)

### Editor/Visualizador de Sequ√™ncias

**Falta criar:**
- `/sequencias/:id` - P√°gina de edi√ß√£o/visualiza√ß√£o
- Componentes:
  - `StepList.tsx` - Lista de passos com drag & drop
  - `StepCardText.tsx` - Editor de passo texto
  - `StepCardMedia.tsx` - Editor de m√≠dia
  - `AddStepMenu.tsx` - Menu para adicionar novos passos
  - `PreviewWhats.tsx` - Preview estilo WhatsApp

**Funcionalidades necess√°rias:**
- ‚úèÔ∏è Adicionar/remover/reordenar passos
- üíæ Salvar mudan√ßas (PUT /api/sequences/:id/steps)
- üì± Preview em tempo real
- üß™ Bot√£o "Testar Envio" com modal
- üîí Modo read-only para published/archived
- ‚úÖ Valida√ß√µes de formul√°rio

### Integra√ß√£o com Campanhas

**No wizard de campanha existente:**
- Adicionar `SequenceSelectStep.tsx`
- Listar sequ√™ncias publicadas
- Ao selecionar: PUT /api/campaigns/:id/sequence { sequence_id }
- Mostrar preview da sequ√™ncia selecionada

---

## üß™ Testando a API

### Via cURL

```bash
# 1. Obter token JWT (autentica√ß√£o)
TOKEN="seu-jwt-token"
ORG_ID="seu-org-uuid"

# 2. Criar sequ√™ncia
curl -X POST http://localhost:3000/api/sequences \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Org-Id: $ORG_ID" \
  -H "Content-Type: application/json" \
  -d '{"name":"Teste API","channel":"whatsapp"}'

# 3. Listar sequ√™ncias
curl -X GET "http://localhost:3000/api/sequences?status=draft" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Org-Id: $ORG_ID"

# 4. Adicionar passos (use o ID retornado)
SEQUENCE_ID="uuid-da-sequencia"
curl -X PUT http://localhost:3000/api/sequences/$SEQUENCE_ID/steps \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Org-Id: $ORG_ID" \
  -H "Content-Type: application/json" \
  -d '{
    "steps": [
      {
        "kind": "text",
        "cfg": {"text": "Ol√° {first_name}!", "delayNextSeconds": 5}
      }
    ]
  }'

# 5. Publicar
curl -X POST http://localhost:3000/api/sequences/$SEQUENCE_ID/publish \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Org-Id: $ORG_ID"
```

---

## üêõ Troubleshooting

### Erro: "missing_org_id"
- Verifique se est√° enviando header `X-Org-Id`
- Confirme que o JWT cont√©m `org_id` no payload

### Erro: "sequence_not_found"
- Confirme que o UUID est√° correto
- Verifique se a sequ√™ncia pertence ao org_id informado

### Erro: "sequence_not_draft"
- S√≥ √© poss√≠vel editar sequ√™ncias em status `draft`
- Use "Duplicar" para criar uma c√≥pia edit√°vel

### Busca n√£o funciona corretamente
- Certifique-se de que a extens√£o `unaccent` est√° habilitada:
  ```sql
  CREATE EXTENSION IF NOT EXISTS unaccent;
  ```

### Erro ao publicar: "sequence_requires_at_least_one_step"
- Adicione pelo menos 1 passo antes de publicar
- Use PUT /api/sequences/:id/steps

---

## üìä Status da Implementa√ß√£o

| Funcionalidade | Backend | Frontend | Status |
|----------------|---------|----------|--------|
| Listar sequ√™ncias | ‚úÖ | ‚úÖ | **Completo** |
| Criar sequ√™ncia | ‚úÖ | ‚úÖ | **Completo** |
| Duplicar sequ√™ncia | ‚úÖ | ‚úÖ | **Completo** |
| Arquivar sequ√™ncia | ‚úÖ | ‚úÖ | **Completo** |
| Filtros e busca | ‚úÖ | ‚úÖ | **Completo** |
| Editor de passos | ‚úÖ | ‚ùå | **Pendente** |
| Preview WhatsApp | ‚úÖ | ‚ùå | **Pendente** |
| Teste de envio | ‚úÖ | ‚ùå | **Pendente** |
| Integra√ß√£o N8N | ‚úÖ | N/A | **Completo** |
| Integra√ß√£o com Campanhas | ‚úÖ | ‚ùå | **Pendente** |

---

## üîó Links √öteis

- [README Principal](./README.md)
- [README Campanhas](./README_CAMPANHAS.md)
- Banco de dados: PostgreSQL via `backend/src/db.ts`
- Autentica√ß√£o: JWT via `backend/src/middlewares/auth.ts`

---

## üìû Suporte

Para d√∫vidas ou problemas:
1. Verifique os logs do backend: `backend/src/logger.ts`
2. Inspecione a rede no DevTools (aba Network)
3. Confirme que todas as tabelas e √≠ndices foram criados
4. Valide que o N8N est√° configurado e respondendo

---

**√öltima atualiza√ß√£o:** 2025-01-17
**Vers√£o:** 1.0.0
